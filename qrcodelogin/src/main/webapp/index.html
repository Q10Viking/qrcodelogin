<!DOCTYPE html>
 <html>
 <head>
     <title>myluban扫码登录Demo</title>
　　　<meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport' />
　　　<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 </head>
 <body>
    <body>
		<input id="token" type="hidden" value="" /> 
	    <img id="qrcode" width="280" style="margin-left:750px;margin-top:280px;" height="280" src="" />
	</body>
 </body>
 <script type="text/javascript" src="http://libs.baidu.com/jquery/1.9.1/jquery.min.js"></script>
 <script type="text/javascript" src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.js"></script> 
 <script type="text/javascript">
	$(document).ready(function(){ 
	　　$.get("http://localhost:8080/qrcodelogin/rest/qrcodelogin/qrcode", function(data, status) {
			$("#qrcode").attr("src","data:image/png;base64,"+data.base64Qrcode);
			startWebsocket(data.token);
		});
	}); 
	function startWebsocket(token) {
		var websocket = null;
		//判断当前浏览器是否支持WebSocket
		if ('WebSocket' in window) {
			websocket = new WebSocket("ws://localhost:8080/qrcodelogin/loginpage/" +token);
		} else {
			alert('当前浏览器 Not support websocket')
		}

		//连接发生错误的回调方法
		websocket.onerror = function () {
			alert("WebSocket连接发生错误");
		};

		//连接成功建立的回调方法
		websocket.onopen = function () {
			console.log("WebSocket连接成功");
		}

		//接收到消息的回调方法
		websocket.onmessage = function (event) {
			if(event.data =='201'){
			 weblogin(token);
			}
            if(event.data=='202') {
                alert("二维码扫描成功，提示app确认");
            }
			if(event.data=='203') {
			 alert("二维码失效");
			}
		}

		//连接关闭的回调方法
		websocket.onclose = function () {
			console.log("WebSocket连接关闭");
		}

		//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
		window.onbeforeunload = function () {
			websocket.close();
		}
	 }
	 function weblogin(token) {
         $.ajax({
             url: "http://localhost:8080/qrcodelogin/rest/qrcodelogin/weblogin/"+token,
             type: "GET",
             xhrFields: {
                 withCredentials: true
             },
             success: function(data) {
                 if (data != null) {
                     alert("二维码扫描登录成功!");
                 }
             },
             error: function(XMLHttpRequest, textStatus, errorThrown) {

             }
         });
	 }
 </script>
</html>